---
- name: Ensure RocketChat project directory exists
  ansible.builtin.file:
    path: /opt/rocketchat
    state: directory
    mode: '0755'

- name: Ensure Docker data directory exists on secondary disk
  ansible.builtin.file:
    path: /var/lib/docker/data
    state: directory
    mode: '0755'

- name: Create symlink for /var/lib/docker-data
  ansible.builtin.file:
    src: /var/lib/docker/data
    dest: /var/lib/docker-data
    state: link

- name: Ensure /var/lib/docker is traversable by other users
  ansible.builtin.file:
    path: /var/lib/docker
    mode: '0711' # rwx --x --x (allow traversal)

- name: Ensure target data directories exist with correct ownership
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: "{{ item.mode }}"
    recurse: true
  loop:
    - { path: '/var/lib/docker-data/rocketchat-mongo', owner: '999', group: '0', mode: '0755' }
    - { path: '/var/lib/docker-data/rocketchat-uploads', owner: '999', group: '999', mode: '0777' }

- name: Copy RocketChat Docker Compose file
  ansible.builtin.copy:
    src: rocketchat/docker-compose.yml
    dest: /opt/rocketchat/docker-compose.yml
    mode: '0644'

- name: Render .env file (if needed)
  ansible.builtin.template:
    src: rocketchat/.env.j2
    dest: /opt/rocketchat/.env
    mode: '0644'
  ignore_errors: true

- name: Run RocketChat Docker Compose stack
  community.docker.docker_compose_v2:
    project_src: /opt/rocketchat
    state: present
    pull: always

- name: Validate MongoDB storage disk
  ansible.builtin.shell: docker exec rc-mongo df -h /data/db
  register: mongo_disk_check
  changed_when: false

- name: Print MongoDB storage validation
  ansible.builtin.debug:
    var: mongo_disk_check.stdout_lines
